import{jz as R,S as H,c1 as Y,G as l,H as u,ca as K,cb as X,c4 as B,b3 as Q,af as ee,V as te,ce as re,I as _,b as J,jA as ie,cF as se,dY as oe,eg as ne,jB as ae,f2 as z,az as le,R as ue,cH as pe,cG as ye,ar as ce,ew as de,ey as fe,dd as he,s as A,eU as L,aP as me,i3 as ge,b5 as be,aJ as we,e$ as ve,aO as M,jC as xe,b4 as Se,bG as Ie}from"./index-B1clX_ad.js";import{n as T}from"./floorFilterUtils-DZ5C6FQv.js";import{o as U}from"./drapedUtils-C1icbIoN.js";import{n as $e,p as Oe}from"./popupUtils-DsOwz_o6.js";function Je(r,e,i){return e.flatten(({sublayers:t})=>t).length!==r.length?!0:!!r.some(t=>t.originIdOf("minScale")>i||t.originIdOf("maxScale")>i||t.originIdOf("renderer")>i||t.originIdOf("labelingInfo")>i||t.originIdOf("opacity")>i||t.originIdOf("labelsVisible")>i||t.originIdOf("source")>i)||!q(r,e)}function Ee(r,e,i){return!!r.some(s=>{var c,p,a;const t=s.source,o=!t||t.type==="map-layer"&&t.mapLayerId===s.id&&(t.gdbVersion==null||t.gdbVersion===i);s.commitProperty("renderer"),s.commitProperty("labelingInfo"),s.commitProperty("opacity"),s.commitProperty("labelsVisible"),s.commitProperty("orderBy");const n=((a=(p=(c=s.layer)==null?void 0:c.capabilities)==null?void 0:p.exportMap)==null?void 0:a.supportsSublayerOrderBy)??!1;return!o||s.originIdOf("renderer")>R.SERVICE||s.originIdOf("labelingInfo")>R.SERVICE||s.originIdOf("opacity")>R.SERVICE||s.originIdOf("labelsVisible")>R.SERVICE||n&&s.originIdOf("orderBy")>R.SERVICE})||!q(r,e)}function q(r,e){if(!(r!=null&&r.length)||e==null)return!0;const i=e.slice().reverse().flatten(({sublayers:o})=>o&&o.toArray().reverse()).map(o=>o.id).toArray();if(r.length>i.length)return!1;let s=0;const t=i.length;for(const{id:o}of r){for(;s<t&&i[s]!==o;)s++;if(s>=t)return!1}return!0}function ze(r){return!!r&&r.some(e=>{var i;return e.minScale!=null||((i=e.layerDefinition)==null?void 0:i.minScale)!=null})}var N;let f=N=class extends H{static from(r){return Y(N,r)}constructor(r){super(r),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.historicMoment=null,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}writeHistoricMoment(r,e){e.historicMoment=r&&r.getTime()}};l([u({type:Number,json:{write:!0}})],f.prototype,"dpi",void 0),l([u()],f.prototype,"floors",void 0),l([u({type:String,json:{write:!0}})],f.prototype,"gdbVersion",void 0),l([u({types:X,json:{read:K,write:!0}})],f.prototype,"geometry",void 0),l([u({type:Number,json:{write:!0}})],f.prototype,"geometryPrecision",void 0),l([u({type:Number,json:{write:!0}})],f.prototype,"height",void 0),l([u({type:Date})],f.prototype,"historicMoment",void 0),l([B("historicMoment")],f.prototype,"writeHistoricMoment",null),l([u({type:[Number],json:{write:!0}})],f.prototype,"layerIds",void 0),l([u({type:["top","visible","all","popup"],json:{write:!0}})],f.prototype,"layerOption",void 0),l([u({type:Q,json:{write:!0}})],f.prototype,"mapExtent",void 0),l([u({type:Number,json:{write:!0}})],f.prototype,"maxAllowableOffset",void 0),l([u({type:Boolean,json:{write:!0}})],f.prototype,"returnFieldName",void 0),l([u({type:Boolean,json:{write:!0}})],f.prototype,"returnGeometry",void 0),l([u({type:Boolean,json:{write:!0}})],f.prototype,"returnM",void 0),l([u({type:Boolean,json:{write:!0}})],f.prototype,"returnUnformattedValues",void 0),l([u({type:Boolean,json:{write:!0}})],f.prototype,"returnZ",void 0),l([u({type:ee,json:{write:!0}})],f.prototype,"spatialReference",void 0),l([u({type:te})],f.prototype,"sublayers",void 0),l([u({type:re,json:{write:!0}})],f.prototype,"timeExtent",void 0),l([u({type:Number,json:{write:!0}})],f.prototype,"tolerance",void 0),l([u({type:Number,json:{write:!0}})],f.prototype,"width",void 0),f=N=l([_("esri.rest.support.IdentifyParameters")],f);const D=f;let $=class extends H{constructor(r){super(r),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(r,e){return J.fromJSON({attributes:{...e.attributes},geometry:{...e.geometry}})}writeFeature(r,e){if(!r)return;const{attributes:i,geometry:s}=r;i&&(e.attributes={...i}),s!=null&&(e.geometry=s.toJSON(),e.geometryType=ie.toJSON(s.type))}};l([u({type:String,json:{write:!0}})],$.prototype,"displayFieldName",void 0),l([u({type:J})],$.prototype,"feature",void 0),l([se("feature",["attributes","geometry"])],$.prototype,"readFeature",null),l([B("feature")],$.prototype,"writeFeature",null),l([u({type:Number,json:{write:!0}})],$.prototype,"layerId",void 0),l([u({type:String,json:{write:!0}})],$.prototype,"layerName",void 0),$=l([_("esri.rest.support.IdentifyResult")],$);const Fe=$;function Pe(r,e){const{dpi:i,gdbVersion:s,geometry:t,geometryPrecision:o,height:n,historicMoment:c,layerOption:p,mapExtent:a,maxAllowableOffset:y,returnFieldName:d,returnGeometry:m,returnUnformattedValues:x,returnZ:I,spatialReference:E,timeExtent:h,tolerance:O,width:w}=r.toJSON(),{dynamicLayers:b,layerDefs:v,layerIds:j}=je(r),P=(e==null?void 0:e.geometry)!=null?e.geometry:null,g={historicMoment:c,geometryPrecision:o,maxAllowableOffset:y,returnFieldName:d,returnGeometry:m,returnUnformattedValues:x,returnZ:I,tolerance:O},S=(P==null?void 0:P.toJSON())||t;g.imageDisplay=`${w},${n},${i}`,s&&(g.gdbVersion=s),S&&(delete S.spatialReference,g.geometry=JSON.stringify(S),g.geometryType=oe(S));const V=E??(S==null?void 0:S.spatialReference)??(a==null?void 0:a.spatialReference);if(V&&(g.sr=ne(V)),g.time=h?[h.start,h.end].join(","):null,a){const{xmin:C,ymin:k,xmax:Z,ymax:W}=a;g.mapExtent=`${C},${k},${Z},${W}`}return v&&(g.layerDefs=v),b&&!v&&(g.dynamicLayers=b),g.layers=p==="popup"?"visible":p,j&&!b&&(g.layers+=`:${j.join(",")}`),g}function je(r){var I,E;const{mapExtent:e,floors:i,width:s,sublayers:t,layerIds:o,layerOption:n,gdbVersion:c}=r,p=(E=(I=t==null?void 0:t.find(h=>h.layer!=null))==null?void 0:I.layer)==null?void 0:E.serviceSublayers,a=n==="popup",y={},d=ae({extent:e,width:s,spatialReference:e==null?void 0:e.spatialReference}),m=[],x=h=>{const O=d===0,w=h.minScale===0||d<=h.minScale,b=h.maxScale===0||d>=h.maxScale;if(h.visible&&(O||w&&b))if(h.sublayers)h.sublayers.forEach(x);else{if((o==null?void 0:o.includes(h.id))===!1||a&&(!h.popupTemplate||!h.popupEnabled))return;m.unshift(h)}};if(t==null||t.forEach(x),t&&!m.length)y.layerIds=[];else{const h=Ee(m,p,c),O=m.map(w=>{const b=T(i,w);return w.toExportImageJSON(b)});if(h)y.dynamicLayers=JSON.stringify(O);else{if(t){let b=m.map(({id:v})=>v);o&&(b=b.filter(v=>o.includes(v))),y.layerIds=b}else o!=null&&o.length&&(y.layerIds=o);const w=Re(i,m);if(w!=null&&w.length){const b={};for(const v of w)v.definitionExpression&&(b[v.id]=v.definitionExpression);Object.keys(b).length&&(y.layerDefs=JSON.stringify(b))}}}return y}function Re(r,e){const i=!!(r!=null&&r.length),s=e.filter(t=>t.definitionExpression!=null||i&&t.floorInfo!=null);return s.length?s.map(t=>{const o=T(r,t),n=z(o,t.definitionExpression);return{id:t.id,definitionExpression:n??void 0}}):null}async function Ve(r,e,i){const s=(e=Ne(e)).geometry?[e.geometry]:[],t=le(r);return t.path+="/identify",ue(s).then(o=>{const n=Pe(e,{geometry:o==null?void 0:o[0]}),c=pe({...t.query,f:"json",...n}),p=ye(c,i);return ce(t.path,p).then(Ge).then(a=>_e(a,e.sublayers))})}function Ge(r){const e=r.data;return e.results=e.results||[],e.exceededTransferLimit=!!e.exceededTransferLimit,e.results=e.results.map(i=>Fe.fromJSON(i)),e}function Ne(r){return r=D.from(r)}function _e(r,e){if(!(e!=null&&e.length))return r;const i=new Map;function s(t){i.set(t.id,t),t.sublayers&&t.sublayers.forEach(s)}e.forEach(s);for(const t of r.results)t.feature.sourceLayer=i.get(t.layerId);return r}let G=null;function qe(r,e){return e.type==="tile"||e.type==="map-image"}let F=class extends de{constructor(r){super(r),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=fe(async e=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch(()=>{}))})}initialize(){const r=e=>{for(const i of e){const{sourceLayer:s}=i;s!=null&&"geometryType"in s&&s.geometryType==="point"&&(i.visible=!1)}this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e).catch(()=>{})),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([he(()=>this.highlightGraphics,"change",e=>r(e.added),{onListenerAdd:e=>r(e)})])}async fetchPopupFeaturesAtLocation(r,e){var n,c;const{layerView:{layer:i,view:{scale:s}}}=this;if(!r)throw new A("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:i});const t=Te(i.sublayers,s,e);if(!t.length)return[];const o=await Le(i,t);if(!((((c=(n=i.capabilities)==null?void 0:n.operations)==null?void 0:c.supportsIdentify)??!0)&&i.version>=10.5)&&!o)throw new A("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:i});return o?this._fetchPopupFeaturesUsingQueries(r,t,e):this._fetchPopupFeaturesUsingIdentify(r,t,e)}clearHighlights(){var r;(r=this.highlightGraphics)==null||r.removeAll()}async _updateHighlightedFeaturesSymbols(r){const{layerView:{view:e},highlightGraphics:i,highlightGraphicUpdated:s}=this;if(i&&s)for(const t of r){const o=t.sourceLayer&&"renderer"in t.sourceLayer&&t.sourceLayer.renderer;t.sourceLayer&&"geometryType"in t.sourceLayer&&t.sourceLayer.geometryType==="point"&&o&&"getSymbolAsync"in o&&o.getSymbolAsync(t).then(async n=>{var a;n||(n=new L);let c=null;const p="visualVariables"in o?(a=o.visualVariables)==null?void 0:a.find(y=>y.type==="size"):void 0;p&&(G||(G=(await me(async()=>{const{getSize:y}=await import("./index-B1clX_ad.js").then(d=>d.uU);return{getSize:y}},[])).getSize),c=G(p,t,{view:e.type,scale:e.scale,shape:n.type==="simple-marker"?n.style:null})),c||(c="width"in n&&"height"in n&&n.width!=null&&n.height!=null?Math.max(n.width,n.height):"size"in n?n.size:16),i.includes(t)&&(t.symbol=new L({style:"square",size:c,xoffset:"xoffset"in n?n.xoffset:0,yoffset:"yoffset"in n?n.yoffset:0}),s(t,"symbol"),t.visible=!0)})}}async _updateHighlightedFeaturesGeometries(r){const{layerView:{layer:e,view:i},highlightGraphics:s,highlightGraphicUpdated:t}=this;if(this._highlightGeometriesResolution=r,!t||!(s!=null&&s.length)||!e.capabilities.operations.supportsQuery)return;const o=this._getTargetResolution(r),n=new Map;for(const a of s)if(!this._featuresResolutions.has(a)||this._featuresResolutions.get(a)>o){const y=a.sourceLayer;ge(n,y,()=>new Map).set(a.getObjectId(),a)}const c=Array.from(n,([a,y])=>{const d=a.createQuery();return d.objectIds=[...y.keys()],d.outFields=[a.objectIdField],d.returnGeometry=!0,d.maxAllowableOffset=o,d.outSpatialReference=i.spatialReference,a.queryFeatures(d)}),p=await Promise.all(c);if(!this.destroyed)for(const{features:a}of p)for(const y of a){const d=y.sourceLayer,m=n.get(d).get(y.getObjectId());m&&s.includes(m)&&(m.geometry=y.geometry,t(m,"geometry"),this._featuresResolutions.set(m,o))}}_getTargetResolution(r){const e=r*be(this.layerView.view.spatialReference),i=e/16;return i<=10?0:r/e*i}async _fetchPopupFeaturesUsingIdentify(r,e,i){const s=await this._createIdentifyParameters(r,e,i);if(s==null)return[];const{results:t}=await Ve(this.layerView.layer.parsedUrl,s,i);return t.map(o=>o.feature)}async _createIdentifyParameters(r,e,i){const{floors:s,layer:t,timeExtent:o,view:{spatialReference:n,scale:c}}=this.layerView;if(!e.length)return null;await Promise.all(e.map(({sublayer:x})=>x.load(i).catch(()=>{})));const p=Math.min(we("mapservice-popup-identify-max-tolerance"),t.allSublayers.reduce((x,I)=>I.renderer?U({renderer:I.renderer,pointerType:i==null?void 0:i.pointerType}):x,2)),a=this.createFetchPopupFeaturesQueryGeometry(r,p),y=ve(c,n),d=Math.round(a.width/y),m=new Q({xmin:a.center.x-y*d,ymin:a.center.y-y*d,xmax:a.center.x+y*d,ymax:a.center.y+y*d,spatialReference:a.spatialReference});return new D({floors:s,gdbVersion:"gdbVersion"in t?t.gdbVersion:void 0,geometry:r,height:d,layerOption:"popup",mapExtent:m,returnGeometry:!0,spatialReference:n,sublayers:t.sublayers,timeExtent:o,tolerance:p,width:d})}async _fetchPopupFeaturesUsingQueries(r,e,i){const{layerView:{floors:s,timeExtent:t}}=this,o=e.map(async({sublayer:n,popupTemplate:c})=>{var v,j,P;if(await n.load(i).catch(()=>{}),n.capabilities&&!n.capabilities.operations.supportsQuery)return[];const p=n.createQuery(),a=U({renderer:n.renderer,pointerType:i==null?void 0:i.pointerType}),y=this.createFetchPopupFeaturesQueryGeometry(r,a),d=new Set,[m]=await Promise.all([$e(n,c),(v=n.renderer)==null?void 0:v.collectRequiredFields(d,n.fieldsIndex)]);M(i),xe(d,n.fieldsIndex,m);const x=Array.from(d).sort();p.geometry=y,p.outFields=x,p.timeExtent=t;const I=T(s,n);if(p.where=z(p.where,I),((j=n.capabilities)==null?void 0:j.query.supportsOrderBy)&&((P=n.orderBy)==null?void 0:P[0])){const g=n.orderBy[0],S=!g.valueExpression&&g.field,V=g.order==="ascending"?"asc":"desc";S&&(p.orderByFields=[`${S} ${V}`])}const E=this._getTargetResolution(y.width/a),h=await Ae(c);M(i);const O=n.geometryType==="point"||h&&h.arcadeUtils.hasGeometryOperations(c);O||(p.maxAllowableOffset=E);let{features:w}=await n.queryFeatures(p,i);const b=O?0:E;w=await Me(n,w,i);for(const g of w)this._featuresResolutions.set(g,b);return w});return(await Promise.allSettled(o)).reduce((n,c)=>c.status==="fulfilled"?[...n,...c.value]:n,[]).filter(Se)}};function Te(r,e,i){const s=[];if(!r)return s;const t=o=>{const n=o.minScale===0||e<=o.minScale,c=o.maxScale===0||e>=o.maxScale;if(o.visible&&n&&c){if(o.sublayers)o.sublayers.forEach(t);else if(o.popupEnabled){const p=Oe(o,{...i,defaultPopupTemplateEnabled:!1});p!=null&&s.unshift({sublayer:o,popupTemplate:p})}}};return r.map(t),s}function Ae(r){var e;return(e=r.expressionInfos)!=null&&e.length||Array.isArray(r.content)&&r.content.some(i=>i.type==="expression")?Ie():Promise.resolve()}async function Le(r,e){var i,s;if((s=(i=r.capabilities)==null?void 0:i.operations)!=null&&s.supportsQuery)return!0;try{return await Promise.any(e.map(({sublayer:t})=>t.load().then(()=>t.capabilities.operations.supportsQuery)))}catch{return!1}}async function Me(r,e,i){const s=r.renderer;return s&&"defaultSymbol"in s&&!s.defaultSymbol&&(e=s.valueExpression?await Promise.all(e.map(t=>s.getSymbolAsync(t,i).then(o=>o?t:null))).then(t=>t.filter(o=>o!=null)):e.filter(t=>s.getSymbol(t)!=null)),e}l([u({constructOnly:!0})],F.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),l([u({constructOnly:!0})],F.prototype,"layerView",void 0),l([u({constructOnly:!0})],F.prototype,"highlightGraphics",void 0),l([u({constructOnly:!0})],F.prototype,"highlightGraphicUpdated",void 0),l([u({constructOnly:!0})],F.prototype,"updatingHandles",void 0),F=l([_("esri.views.layers.support.MapServiceLayerViewHelper")],F);export{qe as P,F as S,Je as e,Ee as i,ze as o};
