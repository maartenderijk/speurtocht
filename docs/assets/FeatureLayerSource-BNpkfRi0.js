const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/meshFeatureSet-B21ijYFE.js","assets/index-BHVnKyhT.js","assets/axisAngleDegrees-ztj7DR2f.js","assets/quat-DpJVz7ox.js","assets/mat3f64-q3fE-ZOt.js","assets/quatf64-aQ5IuZRd.js","assets/MeshComponent-Bt_nWgPH.js","assets/meshProperties-C4iW0Ukm.js","assets/MeshLocalVertexSpace-Bk8p_RUS.js","assets/MeshTransform-CvId4_bT.js","assets/mat4f64-Dk4dwAN8.js","assets/MeshVertexAttributes-0G08HTuC.js","assets/meshVertexSpaceUtils-CxBe8FOT.js","assets/triangulationUtils-D5tbWGtQ.js","assets/earcut-D9gy186-.js","assets/Indices-BVHo2M6k.js","assets/plane-CSG-07l9.js","assets/deduplicate-BRaLgD5Z.js","assets/projectPointToVector-CpLCxy_S.js","assets/vertexSpaceConversion-CD_YNmfv.js","assets/spatialReferenceEllipsoidUtils-DiMo9y2J.js","assets/computeTranslationToOriginAndRotation-Ctz-Qpl9.js","assets/vec3-BEfrtMyl.js","assets/BufferView-CkAzLrFo.js","assets/vec4-C3Ls6GiW.js","assets/meshFeatureAttributes-BJSo_xdV.js","assets/executeRelationshipQuery-CwhVA7fD.js","assets/query-CFRkR4Kt.js","assets/pbfQueryUtils-Dj6QSXlZ.js","assets/pbf-a_p0sNEc.js","assets/memoryEstimations-BUE6DQXJ.js","assets/OptimizedFeatureSet-Cn6HMkdb.js","assets/queryAttachments-SZllcczZ.js","assets/AttachmentInfo-Dlggh1B1.js","assets/executeAttributeBinsQuery-B5IezI3N.js","assets/AttributeBinsFeatureSet-BupiFyOJ.js","assets/AttributeBinsQuery-DyXi_YVB.js","assets/queryUtils-CKDmdfmI.js","assets/json-Wa8cmqdu.js","assets/FixedIntervalBinParameters-wjgQWWn0.js","assets/executeTopFeaturesQuery-BrFhDey1.js","assets/queryTopFeatures-BYvQbTfG.js","assets/TopFeaturesQuery-pPzkz1HY.js","assets/executeForTopIds-UESjo115.js","assets/executeForTopExtents-DMrY-BC8.js","assets/executeForTopCount-DH-lCzyE.js","assets/uploadAssets-BsdtZdjI.js","assets/convertMeshVertexSpace-8e5sprNt.js"])))=>i.map(i=>d[i]);
import{ar as g,aO as Y,gG as ne,lb as ie,lc as oe,s as F,e as W,ld as ue,ab as le,le as ce,fq as J,n as V,jL as de,b as he,ca as pe,az as P,aA as T,b3 as K,gK as ye,aI as fe,ew as me,d0 as ge,aJ as j,ay as _e,f1 as O,aP as _,lf as ee,lg as be,G as m,H as b,I as te,lh as Se,ey as we,df as Re,li as N,b4 as L,lj as Ie,lk as Oe,ll as Fe,lm as Ae,c8 as re,ln as qe,ce as xe,j2 as Ee,av as G,dy as k,aN as ve,jI as Te,dW as De,jV as Pe,aq as Ce,r as Ne,af as Me,lo as Ve}from"./index-BHVnKyhT.js";import{n as Le}from"./MeshLocalVertexSpace-Bk8p_RUS.js";import{t as Ge}from"./meshVertexSpaceUtils-CxBe8FOT.js";import{N as je}from"./MeshTransform-CvId4_bT.js";import{isFeatureIdentifierArrayWithGlobalId as Qe,isFeatureIdentifierArrayWithObjectId as Je}from"./editingSupport-CFG-Bs7Y.js";import{S as ke,x as Ue,p as $e,f as Be}from"./query-CFRkR4Kt.js";import{a as Ze,s as ze}from"./executeQueryJSON-DacJYBKO.js";import{M as He,u as Xe}from"./featureConversionUtils-l2BVzl9X.js";let se=class{constructor(e,r,s){this.assetName=e,this.assetMimeType=r,this.parts=s}equals(e){return this===e||this.assetName===e.assetName&&this.assetMimeType===e.assetMimeType&&ne(this.parts,e.parts,(r,s)=>r.equals(s))}isOnService(e){return this.parts.every(r=>r.isOnService(e))}makeHash(){let e="";for(const r of this.parts)e+=r.partHash;return e}async toBlob(e){const{parts:r}=this;if(r.length===1)return r[0].toBlob(e);const s=await Promise.all(r.map(a=>a.toBlob(e)));return Y(e),new Blob(s)}},xt=class{constructor(e,r){this.partUrl=e,this.partHash=r}equals(e){return this===e||this.partUrl===e.partUrl&&this.partHash===e.partHash}isOnService(e){return this.partUrl.startsWith(`${e.path}/assets/`)}async toBlob(e){const{data:r}=await g(this.partUrl,{responseType:"blob"});return Y(e),r}};function vt(t){return Ye(t==null?void 0:t.source)}function U(t){return Array.isArray(t)?t.every(e=>e instanceof se):!1}const $=/^(model\/gltf\+json)|(model\/gltf-binary)$/,B=/\.(gltf|glb)/i;function Ye(t){return t?Array.isArray(t)?t.some(Z):Z(t):!1}function Z(t){if(t instanceof File){const{type:e,name:r}=t;return $.test(e)||B.test(r)}return $.test(t.assetMimeType)||B.test(t.assetName)}function Tt(t,e){if(!t)return!1;const{source:r}=t;return We(r,e)}function Dt(t,e){if(t===e)return!0;const{source:r}=t,{source:s}=e;if(r===s)return!0;if(U(r)&&U(s)){if(r.length!==s.length)return!1;const a=(o,u)=>o.assetName<u.assetName?-1:o.assetName>u.assetName?1:0,n=[...r].sort(a),i=[...s].sort(a);for(let o=0;o<n.length;++o)if(!n[o].equals(i[o]))return!1;return!0}return!1}function We(t,e){if(Array.isArray(t)){const r=t;return r.length>0&&r.every(s=>z(s,e))}return z(t,e)}function z(t,e){return t instanceof se&&t.isOnService(e)}function Pt(t,e){return t instanceof File?ie(t,e):oe(t.assetMimeType,t.assetName,e)}function Ct(t){return Array.isArray(t)?t:[t]}function Ke(t){return!!t.original}async function H(t,e,r){const{geometry:s}=e,a={...e.attributes};if(r!=null&&(s==null?void 0:s.type)==="mesh"){const{transformFieldRoles:n}=r,{origin:i,spatialReference:o,vertexSpace:u}=s,l=s.transform??new je,c=u.type==="local",d=t.spatialReference,R=d.isGeographic,I=W(d,o),p=ue(o,d)&&le(o,d);if(!(c&&R&&p||!c&&!R&&I))return null;const h=ce(i,o,d);if(h==null)return null;if(a[n.originX]=h.x,a[n.originY]=h.y,a[n.originZ]=h.z??0,l!=null){const{translation:q,scale:y,rotation:w}=l,f=c?1:J(o)/J(d);a[n.translationX]=q[0]*f,a[n.translationY]=q[2]*f,a[n.translationZ]=-q[1]*f,a[n.scaleX]=y[0],a[n.scaleY]=y[2],a[n.scaleZ]=y[1],a[n.rotationX]=w[0],a[n.rotationY]=w[2],a[n.rotationZ]=-w[1],a[n.rotationDeg]=w[3]}return{attributes:a}}return s==null?{attributes:a}:s.type==="mesh"||s.type==="extent"?null:{geometry:s.toJSON(),attributes:a}}async function et(t,e){const r=await Promise.all((e.addAttachments??[]).map(n=>X(t,n))),s=await Promise.all((e.updateAttachments??[]).map(n=>X(t,n))),a=e.deleteAttachments??[];return r.length||s.length||a.length?{adds:r,updates:s,deletes:[...a]}:null}async function X(t,e){var c;const{feature:r,attachment:s}=e,{globalId:a,name:n,contentType:i,data:o,uploadId:u}=s,l={globalId:a};if(r&&("attributes"in r?l.parentGlobalId=(c=r.attributes)==null?void 0:c[t.globalIdField]:r.globalId&&(l.parentGlobalId=r.globalId)),u)l.uploadId=u;else if(o){const d=await de(o);d&&(l.contentType=d.mediaType,l.data=d.data),o instanceof File&&(l.name=o.name)}return n&&(l.name=n),i&&(l.contentType=i),l}function tt(t,e,r){if(!e||e.length===0)return[];if(r&&Qe(e))return e.map(a=>a.globalId);if(Je(e))return e.map(a=>a.objectId);const s=r?t.globalIdField:t.objectIdField;return s?e.map(a=>a.getAttribute(s)):[]}function rt(t){var a,n,i;const e=t==null?void 0:t.assetMaps;if(e){for(const o of e.addResults)o.success||V.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${o.globalId}.`);for(const o of e.updateResults)o.success||V.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${o.globalId}.`)}const r=t==null?void 0:t.attachments,s={addFeatureResults:((a=t==null?void 0:t.addResults)==null?void 0:a.map(A))??[],updateFeatureResults:((n=t==null?void 0:t.updateResults)==null?void 0:n.map(A))??[],deleteFeatureResults:((i=t==null?void 0:t.deleteResults)==null?void 0:i.map(A))??[],addAttachmentResults:r!=null&&r.addResults?r.addResults.map(A):[],updateAttachmentResults:r!=null&&r.updateResults?r.updateResults.map(A):[],deleteAttachmentResults:r!=null&&r.deleteResults?r.deleteResults.map(A):[]};return t!=null&&t.editMoment&&(s.editMoment=t.editMoment),s}function A(t){const e=t.success===!0?null:t.error||{code:void 0,description:void 0};return{objectId:t.objectId,globalId:t.globalId,error:e?new F("feature-layer-source:edit-failure",e.description,{code:e.code}):null}}function M(t,e){return new he({attributes:t.attributes,geometry:pe({...t.geometry,spatialReference:e})})}function st(t,e){var r,s,a;return{adds:((r=t==null?void 0:t.adds)==null?void 0:r.map(n=>M(n,e)))||[],updates:((s=t==null?void 0:t.updates)==null?void 0:s.map(n=>({original:M(n[0],e),current:M(n[1],e)})))||[],deletes:((a=t==null?void 0:t.deletes)==null?void 0:a.map(n=>M(n,e)))||[],spatialReference:e}}function at(t){const e=t.details.raw,r=+e.code,s=+e.extendedCode;return r===500&&(s===-2147217144||s===-2147467261)}async function nt(t,e,r){const s=P(t),{data:a}=await ke(s,T.from(e),r);return a.count}async function it(t,e,r){const s=P(t),a=await Ue(s,T.from(e),{...r}),n=a.data.extent;return!n||isNaN(n.xmin)||isNaN(n.ymin)||isNaN(n.xmax)||isNaN(n.ymax)?{count:a.data.count,extent:null}:{count:a.data.count,extent:K.fromJSON(n)}}async function ot(t,e,r){const s=P(t),{data:a}=await $e(s,T.from(e),r);return a.objectIds??[]}function ut(t,e){return e}function Q(t,e,r,s){switch(r){case 0:return D(t,e+s,0);case 1:return t.originPosition==="lowerLeft"?D(t,e+s,1):dt(t,e+s,1)}}function ae(t,e,r,s){return r===2?D(t,e,2):Q(t,e,r,s)}function lt(t,e,r,s){return r===2?e===0?0:D(t,e,3):Q(t,e,r,s)}function ct(t,e,r,s){return r===3?e===0?0:D(t,e,3):ae(t,e,r,s)}function D({translate:t,scale:e},r,s){return t[s]+r*e[s]}function dt({translate:t,scale:e},r,s){return t[s]-r*e[s]}class ht{constructor(e){this._options=e,this.geometryTypes=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"],this._previousCoordinate=[0,0],this._transform=null,this._applyTransform=ut,this._lengths=[],this._currentLengthIndex=0,this._toAddInCurrentPath=0,this._vertexDimension=0,this._mValueOffset=null,this._coordinateBuffer=null,this._coordinateBufferPtr=0,this._attributesConstructor=class{}}createFeatureResult(){return{fields:[],features:[]}}finishFeatureResult(e){if(this._options.applyTransform&&(e.transform=null),this._attributesConstructor=class{},this._coordinateBuffer=null,this._lengths.length=0,!e.hasZ)return;const r=ye(e.geometryType,this._options.sourceSpatialReference,e.spatialReference);if(r!=null)for(const s of e.features)r(s.geometry)}createSpatialReference(){return{}}addField(e,r){const s=e.fields;fe(s),s.push(r);const a=s.map(n=>n.name);this._attributesConstructor=function(){for(const n of a)this[n]=null}}addFeature(e,r){e.features.push(r)}prepareFeatures(e){switch(this._transform=e.transform,this._options.applyTransform&&e.transform&&(this._applyTransform=this._deriveApplyTransform(e)),this._mValueOffset=null,this._vertexDimension=2,e.hasZ&&this._vertexDimension++,e.hasM&&(this._mValueOffset=this._vertexDimension,this._vertexDimension++),e.geometryType){case"esriGeometryPoint":this.addCoordinate=(r,s,a)=>this.addCoordinatePoint(r,s,a),this.createGeometry=r=>this.createPointGeometry(r);break;case"esriGeometryPolygon":this.addCoordinate=(r,s,a)=>this._addCoordinatePolygon(r,s,a),this.createGeometry=r=>this._createPolygonGeometry(r);break;case"esriGeometryPolyline":this.addCoordinate=(r,s,a)=>this._addCoordinatePolyline(r,s,a),this.createGeometry=r=>this._createPolylineGeometry(r);break;case"esriGeometryMultipoint":this.addCoordinate=(r,s,a)=>this._addCoordinateMultipoint(r,s,a),this.createGeometry=r=>this._createMultipointGeometry(r)}}createFeature(){return this._lengths.length=0,this._currentLengthIndex=0,this._previousCoordinate[0]=0,this._previousCoordinate[1]=0,this._coordinateBuffer=null,this._coordinateBufferPtr=0,{attributes:new this._attributesConstructor}}allocateCoordinates(){}addLength(e,r,s){this._lengths.length===0&&(this._toAddInCurrentPath=r),this._lengths.push(r)}addQueryGeometry(e,r){const{queryGeometry:s,queryGeometryType:a}=r,n=this._transform?He(s.clone(),s,!1,!1,this._transform):s.clone(),i=Xe(n,a,!1,!1);e.queryGeometryType=a,e.queryGeometry={...i}}createPointGeometry(e){const r={x:0,y:0,spatialReference:e.spatialReference};return e.hasZ&&(r.z=0),e.hasM&&(r.m=0),r}addCoordinatePoint(e,r,s){const a=this._transform;switch(r=this._applyTransform(a,r,s,0),s){case 0:e.x=r;break;case 1:e.y=r;break;case 2:"z"in e?e.z=r:e.m=r;break;case 3:e.m=r}}_transformPathLikeValue(e,r){let s=0;r<=1&&(s=this._previousCoordinate[r],this._previousCoordinate[r]+=e);const a=this._transform;return this._mValueOffset!==null&&e===0&&r>0&&!(r%this._mValueOffset)?0:this._applyTransform(a,e,r,s)}_addCoordinatePolyline(e,r,s){this._dehydratedAddPointsCoordinate(e.paths,r,s)}_addCoordinatePolygon(e,r,s){this._dehydratedAddPointsCoordinate(e.rings,r,s)}_addCoordinateMultipoint(e,r,s){s===0&&e.points.push([]);const a=this._transformPathLikeValue(r,s);e.points[e.points.length-1].push(a)}_createPolygonGeometry(e){return{rings:[[]],spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM}}_createPolylineGeometry(e){return{paths:[[]],spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM}}_createMultipointGeometry(e){return{points:[],spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM}}_dehydratedAddPointsCoordinate(e,r,s){s===0&&this._toAddInCurrentPath--==0&&(e.push([]),this._toAddInCurrentPath=this._lengths[++this._currentLengthIndex]-1,this._previousCoordinate[0]=0,this._previousCoordinate[1]=0);const a=this._transformPathLikeValue(r,s),n=e[e.length-1];s===0&&(this._coordinateBufferPtr=0,this._coordinateBuffer=new Array(this._vertexDimension),n.push(this._coordinateBuffer)),this._coordinateBuffer[this._coordinateBufferPtr++]=a}_deriveApplyTransform(e){const{hasZ:r,hasM:s}=e;return r&&s?ct:r?ae:s?lt:Q}}async function pt(t,e,r){const s=P(t),a={...r},n=T.from(e),i=!n.quantizationParameters,{data:o}=await Be(s,n,new ht({sourceSpatialReference:n.sourceSpatialReference,applyTransform:i}),a);return o}let S=class extends me{constructor(t){super(t),this.dynamicDataSource=null,this.fieldsIndex=null,this.gdbVersion=null,this.infoFor3D=null,this.pbfSupported=!1,this.queryAttachmentsSupported=!1,this.sourceSpatialReference=null,this.url=null}get parsedUrl(){return ge(this.url)}async execute(t,e){const r=await this.executeJSON(t,e);return this.featureSetFromJSON(t,r,e)}async executeJSON(t,e){var o;const r=this._normalizeQuery(t),s=((o=t.outStatistics)==null?void 0:o[0])!=null,a=j("featurelayer-pbf-statistics"),n=(!s||a)&&t.returnTrueCurves!==!0;let i;if(this.pbfSupported&&n)try{i=await pt(this.url,r,e)}catch(u){if(u.name!=="query:parsing-pbf")throw u;this.pbfSupported=!1}return this.pbfSupported&&n||(i=await Ze(this.url,r,e)),this._normalizeFields(i.fields),i}async featureSetFromJSON(t,e,r){if(!this._queryIs3DObjectFormat(t)||this.infoFor3D==null||!e.features)return _e.fromJSON(e);const{meshFeatureSetFromJSON:s}=await O(_(()=>import("./meshFeatureSet-B21ijYFE.js").then(a=>a.m),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25])),r);return s(t,this.infoFor3D,e)}executeForCount(t,e){return nt(this.url,this._normalizeQuery(t),e)}executeForExtent(t,e){return it(this.url,this._normalizeQuery(t),e)}executeForIds(t,e){return ot(this.url,this._normalizeQuery(t),e)}async executeRelationshipQuery(t,e){const[{default:r},{executeRelationshipQuery:s}]=await O(Promise.all([_(()=>import("./index-BHVnKyhT.js").then(a=>a.uV),[]),_(()=>import("./executeRelationshipQuery-CwhVA7fD.js"),__vite__mapDeps([26,1,27,28,29,30,31]))]),e);return t=r.from(t),(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),s(this.url,t,e)}async executeRelationshipQueryForCount(t,e){const[{default:r},{executeRelationshipQueryForCount:s}]=await O(Promise.all([_(()=>import("./index-BHVnKyhT.js").then(a=>a.uV),[]),_(()=>import("./executeRelationshipQuery-CwhVA7fD.js"),__vite__mapDeps([26,1,27,28,29,30,31]))]),e);return t=r.from(t),(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),s(this.url,t,e)}async executeAttachmentQuery(t,e){const{executeAttachmentQuery:r,fetchAttachments:s,processAttachmentQueryResult:a}=await O(_(()=>import("./queryAttachments-SZllcczZ.js"),__vite__mapDeps([32,1,27,28,29,30,31,33])),e),n=P(this.url);return a(n,await(this.queryAttachmentsSupported?r(n,t,e):s(n,t,e)))}async executeAttributeBinsQuery(t,e){const{executeAttributeBinsQuery:r}=await O(_(()=>import("./executeAttributeBinsQuery-B5IezI3N.js"),__vite__mapDeps([34,1,27,28,29,30,31,35,36,37,38,39])),e);return r(this.parsedUrl,t,e)}async executeTopFeaturesQuery(t,e){const{executeTopFeaturesQuery:r}=await O(_(()=>import("./executeTopFeaturesQuery-BrFhDey1.js"),__vite__mapDeps([40,1,41,27,28,29,30,31,42])),e);return r(this.parsedUrl,t,this.sourceSpatialReference,e)}async executeForTopIds(t,e){const{executeForTopIds:r}=await O(_(()=>import("./executeForTopIds-UESjo115.js"),__vite__mapDeps([43,1,41,27,28,29,30,31,42])),e);return r(this.parsedUrl,t,e)}async executeForTopExtents(t,e){const{executeForTopExtents:r}=await O(_(()=>import("./executeForTopExtents-DMrY-BC8.js"),__vite__mapDeps([44,1,41,27,28,29,30,31,42])),e);return r(this.parsedUrl,t,e)}async executeForTopCount(t,e){const{executeForTopCount:r}=await O(_(()=>import("./executeForTopCount-DH-lCzyE.js"),__vite__mapDeps([45,1,41,27,28,29,30,31,42])),e);return r(this.parsedUrl,t,e)}_normalizeQuery(t){let e=T.from(t);e.sourceSpatialReference=e.sourceSpatialReference||this.sourceSpatialReference,(this.gdbVersion||this.dynamicDataSource)&&(e=e===t?e.clone():e,e.gdbVersion=t.gdbVersion||this.gdbVersion,e.dynamicDataSource=t.dynamicDataSource?ee.from(t.dynamicDataSource):this.dynamicDataSource);const{infoFor3D:r}=this;if(r!=null&&this._queryIs3DObjectFormat(t)){if(e=e===t?e.clone():e,e.formatOf3DObjects=be(r),!e.formatOf3DObjects)throw new F("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(e.outSpatialReference&&!W(e.outSpatialReference,this.sourceSpatialReference))throw new F("query:unsupported-out-spatial-reference","3D object feature services do not support projection of geometries");if(e.outFields==null||!e.outFields.includes("*")){e=e===t?e.clone():e,e.outFields==null&&(e.outFields=[]);const{originX:s,originY:a,originZ:n,translationX:i,translationY:o,translationZ:u,scaleX:l,scaleY:c,scaleZ:d,rotationX:R,rotationY:I,rotationZ:p,rotationDeg:h}=r.transformFieldRoles;e.outFields.push(s,a,n,i,o,u,l,c,d,R,I,p,h)}}return e}_normalizeFields(t){if(this.fieldsIndex!=null&&t!=null)for(const e of t){const r=this.fieldsIndex.get(e.name);r&&Object.assign(e,r.toJSON())}}_queryIs3DObjectFormat(t){return this.infoFor3D!=null&&t.returnGeometry===!0&&t.multipatchOption!=="xyFootprint"&&!t.outStatistics}};m([b({type:ee})],S.prototype,"dynamicDataSource",void 0),m([b()],S.prototype,"fieldsIndex",void 0),m([b()],S.prototype,"gdbVersion",void 0),m([b()],S.prototype,"infoFor3D",void 0),m([b({readOnly:!0})],S.prototype,"parsedUrl",null),m([b()],S.prototype,"pbfSupported",void 0),m([b()],S.prototype,"queryAttachmentsSupported",void 0),m([b()],S.prototype,"sourceSpatialReference",void 0),m([b({type:String})],S.prototype,"url",void 0),S=m([te("esri.layers.graphics.sources.support.QueryTask")],S);const yt=S,ft=new re({originalAndCurrentFeatures:"original-and-current-features",none:"none"}),mt=new re({Started:"published",Publishing:"publishing",Stopped:"unavailable"});let x=class extends Se{constructor(t){super(t),this.type="feature-layer",this.supportedSourceTypes=new Set(["Feature Layer","Oriented Imagery Layer","Table","Catalog Layer"]),this.refresh=we(async()=>{var s,a;await this.load();const e=(s=this.sourceJSON.editingInfo)==null?void 0:s.lastEditDate;if(e==null)return{dataChanged:!0,updates:{}};try{await this._fetchService(null)}catch{return{dataChanged:!0,updates:{}}}const r=e!==((a=this.sourceJSON.editingInfo)==null?void 0:a.lastEditDate);return{dataChanged:r,updates:r?{editingInfo:this.sourceJSON.editingInfo,extent:this.sourceJSON.extent}:null}}),this._ongoingAssetUploads=new Map}load(t){const e=this.layer.sourceJSON,r=this._fetchService(e,{...t}).then(()=>this.layer.setUserPrivileges(this.sourceJSON.serviceItemId,t)).then(()=>this._ensureLatestMetadata(t));return this.addResolvingPromise(r),Promise.resolve(this)}initialize(){this.addHandles([Re(()=>{const t=this.layer;return t&&"lastEditsEventDate"in t?t.lastEditsEventDate:null},t=>this._handleLastEditsEventChange(t))])}destroy(){this._removeEditInterceptor()}get queryTask(){var l;const{capabilities:t,parsedUrl:e,gdbVersion:r,spatialReference:s,fieldsIndex:a}=this.layer,n="infoFor3D"in this.layer?this.layer.infoFor3D:null,i="dynamicDataSource"in this.layer?this.layer.dynamicDataSource:null,o=j("featurelayer-pbf")&&(t==null?void 0:t.query.supportsFormatPBF)&&n==null,u=((l=t==null?void 0:t.operations)==null?void 0:l.supportsQueryAttachments)??!1;return new yt({url:e.path,pbfSupported:o,fieldsIndex:a,infoFor3D:n,dynamicDataSource:i,gdbVersion:r,sourceSpatialReference:s,queryAttachmentsSupported:u})}async addAttachment(t,e){await this.load();const{layer:r}=this;await N(r,"editing");const s=t.attributes[r.objectIdField],a=r.parsedUrl.path+"/"+s+"/addAttachment",n=this._getLayerRequestOptions(),i=this._getFormDataForAttachment(e,n.query);try{const o=await g(a,{body:i});return A(o.data.addAttachmentResult)}catch(o){throw this._createAttachmentErrorResult(s,o)}}async updateAttachment(t,e,r){await this.load();const{layer:s}=this;await N(s,"editing");const a=t.attributes[s.objectIdField],n=s.parsedUrl.path+"/"+a+"/updateAttachment",i=this._getLayerRequestOptions({query:{attachmentId:e}}),o=this._getFormDataForAttachment(r,i.query);try{const u=await g(n,{body:o});return A(u.data.updateAttachmentResult)}catch(u){throw this._createAttachmentErrorResult(a,u)}}async applyEdits(t,e){var E,C;await this.load();const{layer:r}=this;await N(r,"editing");const s="infoFor3D"in r?r.infoFor3D:null,a=s!=null,n=a||((e==null?void 0:e.globalIdUsed)??!1),i=a?await this._uploadMeshesAndGetAssetMapEditsJSON(t):null,o=((E=t.addFeatures)==null?void 0:E.map(v=>H(this.layer,v,s)))??[],u=(await Promise.all(o)).filter(L),l=((C=t.updateFeatures)==null?void 0:C.map(v=>H(this.layer,v,s)))??[],c=(await Promise.all(l)).filter(L),d=tt(this.layer,t.deleteFeatures,n);Ie(u,c,r.spatialReference);const R=await et(this.layer,t),I=r.capabilities.editing.supportsAsyncApplyEdits&&a,p=(e==null?void 0:e.gdbVersion)||r.gdbVersion,h={gdbVersion:p,rollbackOnFailure:e==null?void 0:e.rollbackOnFailureEnabled,useGlobalIds:n,returnEditMoment:e==null?void 0:e.returnEditMoment,usePreviousEditMoment:e==null?void 0:e.usePreviousEditMoment,async:I};await Oe(this.layer.url,p,!0);const q=Fe(this.layer.url,p||null);if(await Ae(r.url,p,r.historicMoment))throw new F("feature-layer-source:historic-version","Editing a historic version is not allowed");e!=null&&e.returnServiceEditsOption?(h.edits=JSON.stringify([{id:r.layerId,adds:u.length?u:null,updates:c.length?c:null,deletes:d.length?d:null,attachments:R,assetMaps:i}]),h.returnServiceEditsOption=ft.toJSON(e==null?void 0:e.returnServiceEditsOption),h.returnServiceEditsInSourceSR=e==null?void 0:e.returnServiceEditsInSourceSR):(h.adds=u.length?JSON.stringify(u):null,h.updates=c.length?JSON.stringify(c):null,h.deletes=d.length?n?JSON.stringify(d):d.join(","):null,h.attachments=R&&JSON.stringify(R),h.assetMaps=i!=null?JSON.stringify(i):void 0);const y=this._getLayerRequestOptions({method:"post",query:h});q&&(y.authMode="immediate",y.query.returnEditMoment=!0,y.query.sessionId=qe);const w=e!=null&&e.returnServiceEditsOption?r.url:r.parsedUrl.path;let f;try{f=I?await this._asyncApplyEdits(w+"/applyEdits",y):await g(w+"/applyEdits",y)}catch(v){if(!at(v))throw v;y.authMode="immediate",f=I?await this._asyncApplyEdits(w+"/applyEdits",y):await g(w+"/applyEdits",y)}return this._createEditsResult(f)}async deleteAttachments(t,e){await this.load();const{layer:r}=this;await N(r,"editing");const s=t.attributes[r.objectIdField],a=r.parsedUrl.path+"/"+s+"/deleteAttachments";try{return(await g(a,this._getLayerRequestOptions({query:{attachmentIds:e.join(",")},method:"post"}))).data.deleteAttachmentResults.map(A)}catch(n){throw this._createAttachmentErrorResult(s,n)}}fetchRecomputedExtents(t={}){const e=t.signal;return this.load({signal:e}).then(async()=>{const r=this._getLayerRequestOptions({...t,query:{returnUpdates:!0}}),{layerId:s,url:a}=this.layer,{data:n}=await g(`${a}/${s}`,r),{id:i,extent:o,fullExtent:u,timeExtent:l}=n,c=o||u;return{id:i,fullExtent:c&&K.fromJSON(c),timeExtent:l&&xe.fromJSON({start:l[0],end:l[1]})}})}async queryAttachments(t,e={}){await this.load();const r=this._getLayerRequestOptions(e);return this.queryTask.executeAttachmentQuery(t,r)}async queryFeatures(t,e){var s;await this.load();const r=await this.queryTask.execute(t,{...e,query:this._createRequestQueryOptions(e)});if((s=t.outStatistics)!=null&&s.length&&r.features.length){const a=new Map;if(r.features.forEach(n=>{var o;const i=n.attributes;(o=t.outStatistics)==null||o.forEach(({outStatisticFieldName:u})=>{if(u){const l=u.toLowerCase();l&&l in i&&u!==l&&(i[u]=i[l],delete i[l],a.set(l,u))}})}),r.fields!=null)for(const n of r.fields){const i=a.get(n.name.toLowerCase());i!=null&&(n.name=i)}}return r}async queryFeaturesJSON(t,e){return await this.load(),this.queryTask.executeJSON(t,{...e,query:this._createRequestQueryOptions(e)})}async queryObjectIds(t,e){return await this.load(),this.queryTask.executeForIds(t,{...e,query:this._createRequestQueryOptions(e)})}async queryFeatureCount(t,e){return await this.load(),this.queryTask.executeForCount(t,{...e,query:this._createRequestQueryOptions(e)})}async queryExtent(t,e){return await this.load(),this.queryTask.executeForExtent(t,{...e,query:this._createRequestQueryOptions(e)})}async queryRelatedFeatures(t,e){return await this.load(),this.queryTask.executeRelationshipQuery(t,{...e,query:this._createRequestQueryOptions(e)})}async queryRelatedFeaturesCount(t,e){return await this.load(),this.queryTask.executeRelationshipQueryForCount(t,{...e,query:this._createRequestQueryOptions(e)})}async queryTopFeatures(t,e){return await this.load(),this.queryTask.executeTopFeaturesQuery(t,{...e,query:this._createRequestQueryOptions(e)})}async queryAttributeBins(t,e){return await this.load(),this.queryTask.executeAttributeBinsQuery(t,{...e,query:this._createRequestQueryOptions(e)})}async queryTopObjectIds(t,e){return await this.load(),this.queryTask.executeForTopIds(t,{...e,query:this._createRequestQueryOptions(e)})}async queryTopExtents(t,e){return await this.load(),this.queryTask.executeForTopExtents(t,{...e,query:this._createRequestQueryOptions(e)})}async queryTopCount(t,e){return await this.load(),this.queryTask.executeForTopCount(t,{...e,query:this._createRequestQueryOptions(e)})}async fetchPublishingStatus(){if(!Ee(this.layer.url))return"unavailable";const t=G(this.layer.url,"status"),e=await g(t,{query:{f:"json"}});return mt.fromJSON(e.data.status)}async uploadAssets(t,e){const{uploadAssets:r}=await _(()=>import("./uploadAssets-BsdtZdjI.js").then(s=>s.u),__vite__mapDeps([46,1,9,10,3,4,5,2,25]));return r(t,{layer:this.layer,ongoingUploads:this._ongoingAssetUploads},e)}_handleLastEditsEventChange(t){var s,a,n,i;const e=this.layer;if(t==null||!("capabilities"in e)||!("effectiveCapabilities"in e)||!(!((a=(s=e.capabilities)==null?void 0:s.operations)!=null&&a.supportsEditing)&&((i=(n=e.effectiveCapabilities)==null?void 0:n.operations)!=null&&i.supportsEditing)))return;const r=e.url;r!=null&&("layerId"in e&&G(r,e.layerId.toString()),this._getOrCreateEditInterceptor(r).before=o=>{const u=o.requestOptions.method??"auto";if(u==="auto"||u==="head"){const l=o.requestOptions.query??{};l._ts=t.getTime(),o.requestOptions.query=l}})}_getOrCreateEditInterceptor(t){return this._editInterceptor==null&&(this._editInterceptor={urls:t},k.request.internalInterceptors.push(this._editInterceptor)),this._editInterceptor}_removeEditInterceptor(){this._editInterceptor!=null&&(ve(k.request.internalInterceptors,this._editInterceptor),this._editInterceptor=null)}async _asyncApplyEdits(t,e){const r=(await g(t,e)).data.statusUrl;for(;;){const s=(await g(r,{query:{f:"json"},responseType:"json"})).data;switch(s.status){case"Completed":return g(s.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw new F("async-applyEdits-failed","asynchronous applyEdits call failed.");case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw new F("async-applyEdits-failed","asynchronous applyEdits call failed (undefined response status)")}await Te(gt)}}_createRequestQueryOptions(t){const e={...this.layer.customParameters,token:this.layer.apiKey,...t==null?void 0:t.query};return this.layer.datesInUnknownTimezone&&(e.timeReferenceUnknownClient=!0),e}async _fetchService(t,e){if(!t){const s={};j("featurelayer-advanced-symbols")&&(s.returnAdvancedSymbols=!0),e!=null&&e.cacheBust&&(s._ts=Date.now());const{data:a}=await g(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:s,signal:e==null?void 0:e.signal}));t=a}this.sourceJSON=await this._patchServiceJSON(t,e==null?void 0:e.signal);const r=t.type;if(!this.supportedSourceTypes.has(r))throw new F("feature-layer-source:unsupported-type",`Source type "${r}" is not supported`)}async _patchServiceJSON(t,e){var r;if(t.type!=="Table"&&t.geometryType&&!((r=t==null?void 0:t.drawingInfo)!=null&&r.renderer)&&!t.defaultSymbol){const s=De(t.geometryType).renderer;Pe("drawingInfo.renderer",s,t)}if(t.geometryType==="esriGeometryMultiPatch"&&t.infoFor3D&&(t.geometryType="mesh"),t.extent==null)try{const{data:s}=await g(this.layer.url,this._getLayerRequestOptions({signal:e}));s.spatialReference&&(t.extent={xmin:0,ymin:0,xmax:0,ymax:0,spatialReference:s.spatialReference})}catch(s){Ce(s)}return t}async _ensureLatestMetadata(t){if(this.layer.userHasUpdateItemPrivileges&&this.sourceJSON.cacheMaxAge>0)return this._fetchService(null,{...t,cacheBust:!0})}async _uploadMeshesAndGetAssetMapEditsJSON(t){const{addAssetFeatures:e}=t;if(!(e!=null&&e.length)||await this._areAllAssetsAlreadyMapped(e))return null;const r=t.addFeatures.filter(n=>n.geometry);if(e.length!==r.length+t.updateFeatures.length)throw new F("feature-layer-source:unsupported-mesh-edits","Mixing attribute only edits with mesh geometry edits is not currently supported");const s=new Array,a=new Map;for(const n of e){const{geometry:i}=n,{vertexSpace:o}=i;if(Ge(o))s.push(i);else{const u=i.origin,{convertMeshVertexSpace:l}=await _(async()=>{const{convertMeshVertexSpace:d}=await import("./convertMeshVertexSpace-8e5sprNt.js");return{convertMeshVertexSpace:d}},__vite__mapDeps([47,1,11,7,19,4,10,20,21,18,12,8,22,23,24])),c=await l(i,new Le({origin:[u.x,u.y,u.z??0]}));a.set(c,i),n.geometry=c,s.push(c)}}await this.uploadAssets(s);for(const[n,i]of a)i.addExternalSources(n.metadata.externalSources.items);return{adds:this._getAssetMapEditsJSON(e),updates:[],deletes:[]}}_getAssetMapEditsJSON(t){const e=new Array,r=this.layer.globalIdField,s=this.layer.parsedUrl;for(const a of t){const n=a.geometry,{metadata:i}=n,o=i.getExternalSourcesOnService(s),u=a.getAttribute(r);if(o.length===0){V.getLogger(this).error(`Skipping feature ${u}. The mesh it is associated with has not been uploaded to the service and cannot be mapped to it.`);continue}const{source:l}=o.find(Ke)??o[0];for(const c of l)c.parts.length===1?e.push({globalId:Ne(),parentGlobalId:u,assetName:c.assetName,assetHash:c.parts[0].partHash,flags:[]}):V.getLogger(this).error(`Skipping asset ${c.assetName}. It does not have exactly one part, so we cannot map it to a feature.`)}return e}_createEditsResult(t){const e=t.data,{layerId:r}=this.layer,s=[];let a=null;if(Array.isArray(e))for(const i of e)s.push({id:i.id,editedFeatures:i.editedFeatures}),i.id===r&&(a={addResults:i.addResults??[],updateResults:i.updateResults??[],deleteResults:i.deleteResults??[],attachments:i.attachments,editMoment:i.editMoment});else a=e;const n=rt(a);if(s.length>0){n.editedFeatureResults=[];for(const i of s){const{editedFeatures:o}=i,u=o!=null&&o.spatialReference?new Me(o.spatialReference):null;n.editedFeatureResults.push({layerId:i.id,editedFeatures:st(o,u)})}}return n}_createAttachmentErrorResult(t,e){var a;const r=((a=e.details.messages)==null?void 0:a[0])||e.message,s=e.details.httpStatus||e.details.messageCode;return{objectId:t,globalId:null,error:new F("feature-layer-source:attachment-failure",r,{code:s})}}_getFormDataForAttachment(t,e){const r=t instanceof FormData?t:t&&t.elements?new FormData(t):null;if(r)for(const s in e){const a=e[s];a!=null&&(r.set?r.set(s,a):r.append(s,a))}return r}_getLayerRequestOptions(t={}){const{layer:e,layer:{parsedUrl:r,gdbVersion:s}}=this;return{...t,query:{gdbVersion:s,layer:"dynamicDataSource"in e&&e.dynamicDataSource?JSON.stringify({source:e.dynamicDataSource}):void 0,...r.query,f:"json",...this._createRequestQueryOptions(t)},responseType:"json"}}async _areAllAssetsAlreadyMapped(t){const{layer:e}=this,{globalIdField:r,parsedUrl:s}=e,a="infoFor3D"in e?e.infoFor3D:null;if(a==null||r==null)return!1;const n=Ve(a);if(n==null)return!1;const i=G(s.path,`../${n.id}`),o=new Array;for(const p of t){if(!(p.geometry.metadata.getExternalSourcesOnService(s).length>0))return!1;o.push(p)}const u=o.map(p=>p.getAttribute(r)).filter(L);if(u.length===0)return!1;const{assetMapFieldRoles:{parentGlobalId:l,assetHash:c}}=a,d=new T({where:`${l} IN (${u.map(p=>`'${p}'`)})`,outFields:[c,l],returnGeometry:!1}),R=await ze(i,d),{features:I}=R;return I.length!==0&&!o.some(p=>{const h=p.getAttribute(r);if(!h)return!0;const{metadata:q}=p.geometry,y=I.filter(f=>f.getAttribute(l)===h);if(y.length===0)return!0;const w=y.map(f=>f.getAttribute(c));return q.getExternalSourcesOnService(s).flatMap(({source:f})=>f.flatMap(E=>E.parts.map(C=>C.partHash))).some(f=>w.every(E=>f!==E))})}};m([b()],x.prototype,"type",void 0),m([b({constructOnly:!0})],x.prototype,"layer",void 0),m([b({constructOnly:!0})],x.prototype,"supportedSourceTypes",void 0),m([b({readOnly:!0})],x.prototype,"queryTask",null),x=m([te("esri.layers.graphics.sources.FeatureLayerSource")],x);const gt=1e3,_t=x,Nt=Object.freeze(Object.defineProperty({__proto__:null,default:_t},Symbol.toStringTag,{value:"Module"}));export{_t as B,yt as F,Ct as N,se as a,Pt as b,nt as c,Nt as d,Dt as h,xt as i,Tt as m,vt as o,ot as s};
